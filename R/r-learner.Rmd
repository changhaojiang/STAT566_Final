---
title: "566report-rlearner"
author: "Tianyang Jiang"
date: '2023-06-01'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
data_dir <- "~/Desktop"
data <- fread(file.path(data_dir, "Diabetes.csv"))
data$scoreCat <- ifelse(data$scoreCat == "> mean score",1,0)
```


R-learner $\newline$
In this section, we investigate the heterogeneous effects of lifestyle factors on subgroups defined by age, sex, and income using the R-learner (Nie and Wager, 2017). This approach utilizes machine learning to estimate treatment effects in observational studies.
The R-learner is used to estimate the Conditional Average Treatment Effect (CATE), $\tau^*(z_1,z_2,z_3) = E(Y(1)-Y(0)|Z_1=z_1,Z_2 = z_2,Z_3 = z_3)$, with $Z_1$, $Z_2$, and $Z_3$ denoting individual features (age, income, and gender) and $Y_i$ the observed outcome.
Using the $\texttt{rlasso}$ method in $\texttt{rlearner}$, we input age, gender, and income as features, and a categorical score as the treatment variable, with diabetes presence indicating observed response. The algorithm of R-learner also includes cross-validation, we set it with ten folds. Finally, we visualize CATE CATE across income levels, gender, and age groups.
```{r}
rW  = cbind(data$Age,data$Sex,data$Income)
rW = as.matrix(rW)
rA = data$scoreCat
rY = data$Diabetes_binary
set.seed(1)

library(rlearner)
rlasso_fit = rlasso(rW, rA, rY,k_folds = 10)
rlasso_est = predict(rlasso_fit, rW)
```

```{r}
plotdata <- data.frame(Income = data$Income, 
                   Estimator =rlasso_est)
plotdata$Income_Group <- cut(plotdata$Income, breaks=c(0,2, 4,6, 8), labels=c("<15000","[15000,25000)","[25000,50000)", ">=50000"))
library(ggplot2)
ggplot(plotdata, aes(x = Income_Group, y = Estimator, fill = Income_Group)) + 
  geom_boxplot() + 
  ggtitle("The result of R-learner(Income)") +
  xlab("Income Group") +
  ylab("Estimator") +
  scale_fill_brewer(palette="Set1") +
  theme_bw()

```
In the visualization of CATE across different income groups, we observe a correlation between higher income and a larger average treatment effect within the same income bracket. This trend is particularly pronounced among individuals earning over $50,000 annually, where the mean effect significantly surpasses that of other groups.
```{r}
plotdata <- data.frame(Sex = data$Sex, 
                   Estimator =rlasso_est)
plotdata$Gender_Group <- ifelse(plotdata$Sex==0,"Female","Male")

library(ggplot2)
ggplot(plotdata, aes(x = Gender_Group, y = Estimator, fill = Gender_Group)) + 
  geom_boxplot() + 
  ggtitle("The result of R-learner(Gender)") +
  xlab("Gender Group") +
  ylab("Estimator") +
  scale_fill_brewer(palette="Set2") +
  theme_bw()

```

When comparing CATE across genders, it is noteworthy that the average treatment effect for females is lower than that for males.

```{r}
plotdata <- data.frame(Age = data$Age, 
                   Estimator =rlasso_est)
plotdata$Age = as.factor(plotdata$Age)
library(ggplot2)
age_labels <- c("18-24","25-29","30-34","35-39","40-44","45-49","51-54","55-59","60-64","65-69","70-74","75-79",">=80")
ggplot(plotdata, aes(x = Age, y = Estimator, fill = Age)) + 
  geom_boxplot() + 
  ggtitle("The result of R-learner(Age)") +
  xlab("Age Group") +
  ylab("Estimator") +
  scale_fill_manual(values = rainbow(length(unique(plotdata$Age))), labels = age_labels) +
  theme_bw()

```

The CATE across age groups shows a distinct decline as age increases. For individuals younger than 24, there is little discernible difference in the outcome between those maintaining good or poor lifestyles.

\newpage
Results(R-learner):
From the R-learner plots, we discern that higher income individuals are less likely to develop diabetes, even have poor lifestyle choices. This pattern is particularly noticeable for those earning over $50,000 annually. Regarding gender, the difference in diabetes risk between good and poor lifestyle habits is more pronounced in females than males, underscoring the importance of healthy habits for women. In terms of age, the substantial variation in CATE across different age groups suggests that maintaining a healthy lifestyle becomes increasingly vital as one ages. This is because poor lifestyle choices are more likely to induce diabetes as age increases.



